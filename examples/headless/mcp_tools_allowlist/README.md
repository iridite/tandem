# MCP Tool Allowlist (Headless)

This example demonstrates a full headless flow for MCP connector tools and routine tool allowlists.

## What it covers

1. Add an MCP server
2. Connect and auto-discover MCP tools (`initialize` + `tools/list`)
3. List MCP tools and global tool registry entries
4. Create a routine with an explicit `allowed_tools` subset
5. Configure routine `output_targets` for artifact destination wiring
6. Trigger a run and verify the run record includes the same `allowed_tools`
7. Watch SSE for MCP and routine events

## Prerequisites

- Tandem engine running with HTTP API (default: `http://127.0.0.1:39731`)
- Optional: `jq` for shell script output formatting

## Environment

Set these before running:

- `TANDEM_BASE_URL` (optional, defaults to `http://127.0.0.1:39731`)
- `MCP_SERVER_NAME` (optional, defaults to `arcade`)
- `MCP_TRANSPORT` (required, example: `https://mcp.arcade.dev/mcp`)
- `MCP_AUTH_BEARER` (optional bearer token; sent as `Authorization: Bearer ...`)
- `TANDEM_AUTOMATION_API` (optional: `routines` or `automations`, defaults to `routines`)

## Run (Bash)

```bash
cd examples/headless/mcp_tools_allowlist
chmod +x flow.sh
MCP_TRANSPORT="https://your-mcp-server.example/mcp" ./flow.sh
```

## Run (PowerShell)

```powershell
cd examples/headless/mcp_tools_allowlist
$env:MCP_TRANSPORT = "https://your-mcp-server.example/mcp"
./flow.ps1
```

## SSE watch (separate terminal)

```bash
curl -N "$TANDEM_BASE_URL/routines/events"
```

You should see events including:

- `mcp.server.connected`
- `mcp.tools.updated`
- `routine.run.created`

## Mission/Automation Benchmarks

Use the benchmark scripts in this folder to measure mission trigger latency in two modes:

1. **Cold start** (`benchmark_cold_start.sh` / `.ps1`):
   - starts a fresh engine process every trial
   - measures:
     - `engine_boot_ms`
     - `mission_trigger_ack_ms`
     - `mission_target_ms` (depends on `BENCH_TARGET_PHASE`)
     - `cold_start_to_mission_target_ms`
2. **Warm engine** (`benchmark_warm_trigger.sh`):
   - expects an already-running engine
   - measures:
     - `mission_trigger_ack_ms`
     - `mission_target_ms`

### PowerShell

```powershell
cd examples/headless/mcp_tools_allowlist
$env:BENCH_RUNS = "10"
.\benchmark_cold_start.ps1
```

Optional env:

- `TANDEM_AUTOMATION_API=routines|automations` (default: `routines`)
- `TANDEM_BASE_URL` (default: `http://127.0.0.1:39731`)
- `TANDEM_ENGINE_CMD` (override engine launch command)

### Bash

```bash
cd examples/headless/mcp_tools_allowlist
chmod +x benchmark_cold_start.sh
BENCH_RUNS=10 BENCH_TARGET_PHASE=trigger ./benchmark_cold_start.sh
```

Optional env:

- `TANDEM_AUTOMATION_API=routines|automations` (default: `routines`)
- `TANDEM_BASE_URL` (default: `http://127.0.0.1:39731`)
- `TANDEM_ENGINE_CMD` (override engine launch command)
- `BENCH_TARGET_PHASE=trigger|started|terminal` (default: `trigger`)
- `TANDEM_API_TOKEN` (if engine auth is enabled)

### Warm Engine (Bash)

Start engine separately, then run:

```bash
cd examples/headless/mcp_tools_allowlist
chmod +x benchmark_warm_trigger.sh
BENCH_RUNS=20 BENCH_TARGET_PHASE=trigger ./benchmark_warm_trigger.sh
```

Outputs:

- Cold start: `cold_start_results.json`
- Warm trigger: `warm_trigger_results.json`
